<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cognitive Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent-color-analyst: #00bcd4;
            --accent-color-companion: #4caf50;
            --accent-color: var(--accent-color-analyst);
            --bg-start: #111827;
            --bg-end: #000000;
            --text-primary: #F3F4F6;
            --text-secondary: #9CA3AF;
            --glass-bg: rgba(31, 41, 55, 0.5);
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-end);
            color: var(--text-primary);
            overflow: hidden;
        }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

        /* Loading Animation */
        #loading-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: var(--bg-end);
            transition: opacity 0.5s ease-out;
        }
        .loader {
            width: 100px; height: 100px; position: relative;
        }
        .loader-dot {
            width: 100%; height: 100%; position: absolute; left: 0; top: 0;
            animation: spin 2s linear infinite;
        }
        .loader-dot::before {
            content: ''; display: block; width: 15%; height: 15%;
            background-color: var(--accent-color); border-radius: 50%;
            box-shadow: 0 0 10px var(--accent-color), 0 0 20px var(--accent-color);
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .loader-dot:nth-child(2) { animation-delay: -0.2s; }
        .loader-dot:nth-child(3) { animation-delay: -0.4s; }
        .loader-dot:nth-child(4) { animation-delay: -0.6s; }
        .loader-dot:nth-child(5) { animation-delay: -0.8s; }

        /* Sidebar styles */
        #sidebar.collapsed .sidebar-text, #sidebar.collapsed .chat-title, #sidebar.collapsed .profile-name { display: none; }
        #sidebar:not(.collapsed):hover .sidebar-text, #sidebar:not(.collapsed) .chat-title, #sidebar:not(.collapsed) .profile-name { display: inline; }
        #sidebar.collapsed { width: 80px; }
        #sidebar:not(.collapsed) { width: 260px; }
        
        /* --- THIS WAS THE BUG FIX --- */
        /* I removed the line: #sidebar.collapsed:hover { width: 80px; } */
        /* It was preventing the media query below from working. */

        /* Responsive sidebar hover */
        @media (min-width: 768px) {
            /* FIX 2: Only hover-open if NOT pinned */
            #sidebar.collapsed:not(.pinned):hover { width: 260px; }
            #sidebar.collapsed:not(.pinned):hover .sidebar-text, 
            #sidebar.collapsed:not(.pinned):hover .chat-title, 
            #sidebar.collapsed:not(.pinned):hover .profile-name { display: inline; }

            /* FIX 2: Add 'pinned' state styles for desktop */
            #sidebar.pinned { width: 260px; }
            #sidebar.pinned .sidebar-text, 
            #sidebar.pinned .chat-title, 
            #sidebar.pinned .profile-name { display: inline; }
            /* Rotate the pin/toggle icon */
            #sidebar.pinned #toggle-icon-desktop { transform: rotate(180deg); }
        }

        #voice-btn.recording:before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 9999px;
            background-color: var(--accent-color);
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        /* Typing indicator animation */
        .typing-dot {
            width: 6px; height: 6px; background-color: var(--text-secondary);
            border-radius: 50%;
            animation: typing-bounce 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: -0.3s; }
        .typing-dot:nth-child(3) { animation-delay: -0.6s; }
        @keyframes typing-bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
    </style>
</head>
<body>

    <div id="loading-overlay" class="flex flex-col items-center justify-center">
        <div class="loader mb-6">
            <div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div>
        </div>
        <h1 id="loading-text" class="font-orbitron text-lg transition-opacity duration-500">Warming up neural nets...</h1>
    </div>

    <div class="flex h-screen">
        <aside id="sidebar" class="bg-black/20 p-4 flex flex-col transition-all duration-300 ease-in-out flex-shrink-0">
            <div class="flex items-center justify-between mb-6">
                 <div class="flex items-center">
                    <svg class="w-8 h-8 text-cyan-400 mr-2 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14.082 2.182a.5.5 0 0 1 .103.557L12.23 8.35a.5.5 0 0 1-.69.318L8.35 6.696a.5.5 0 0 1 .318-.69l4.618-1.956a.5.5 0 0 1 .557.103zM6.696 8.35 8.652 3.732a.5.5 0 0 1 .69-.318l1.956 4.618a.5.5 0 0 1-.103.557L8.35 10.77a.5.5 0 0 1-.69-.318L6.696 8.35zm.004 11.292a.5.5 0 0 1-.103-.557l1.956-4.618a.5.5 0 0 1 .69-.318l2.976 1.26a.5.5 0 0 1 .318.69l-4.618 1.956a.5.5 0 0 1-.557-.103zm11.292-.004a.5.5 0 0 1 .103-.557l-1.956-4.618a.5.5 0 0 1-.69-.318l-2.976 1.26a.5.5 0 0 1-.318.69l4.618 1.956a.5.5 0 0 1 .557-.103z"/></svg>
                    <span class="font-orbitron text-xl font-bold sidebar-text">Cognitive Engine</span>
                </div>
                <div class="flex items-center">
                    <button id="sidebar-toggle-desktop" class="hidden md:block p-2 text-gray-400 hover:text-white">
                        <svg id="toggle-icon-desktop" class="w-6 h-6 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m0 0l7 7m-7-7h18"></path></svg>
                    </button>
                    <button id="sidebar-toggle-mobile" class="md:hidden p-2 text-gray-400 hover:text-white">
                         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </div>

            <button id="new-chat-btn" class="w-full flex items-center p-3 rounded-lg text-left text-sm font-medium bg-white/5 hover:bg-white/10 transition-colors mb-6">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                <span class="sidebar-text">New Chat</span>
            </button>

            <div class="flex-grow overflow-y-auto">
                <p class="text-xs text-gray-500 uppercase font-semibold mb-2 px-3 sidebar-text">History</p>
                <ul id="chat-history-list" class="space-y-1">
                    </ul>
            </div>
            
            <div class="mt-auto pt-4 border-t border-white/10 relative">
                <button id="profile-btn" class="flex items-center w-full p-2 rounded-lg hover:bg-white/10">
                    <img src="https://placehold.co/40x40/111827/F3F4F6?text=U" alt="User" class="w-8 h-8 rounded-full mr-3 flex-shrink-0">
                    <span class="profile-name text-sm font-medium sidebar-text">User</span>
                </button>
                <div id="profile-menu" class="glass absolute bottom-full left-0 mb-2 w-52 p-2 rounded-lg hidden">
                    <ul class="space-y-1">
                        <li><button class="w-full text-left p-2 rounded hover:bg-white/10 text-sm flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>Settings</button></li>
                        <li><button class="w-full text-left p-2 rounded hover:bg-white/10 text-sm flex items-center text-red-400"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>Log Out</button></li>
                    </ul>
                </div>
            </div>
            </aside>

        <main class="flex-1 flex flex-col h-screen overflow-hidden">
            <div id="initial-view" class="flex flex-col items-center justify-center h-full p-4">
                <div class="text-center">
                    <svg class="w-16 h-16 text-cyan-400 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14.082 2.182a.5.5 0 0 1 .103.557L12.23 8.35a.5.5 0 0 1-.69.318L8.35 6.696a.5.5 0 0 1 .318-.69l4.618-1.956a.5.5 0 0 1 .557.103zM6.696 8.35 8.652 3.732a.5.5 0 0 1 .69-.318l1.956 4.618a.5.5 0 0 1-.103.557L8.35 10.77a.5.5 0 0 1-.69-.318L6.696 8.35zm.004 11.292a.5.5 0 0 1-.103-.557l1.956-4.618a.5.5 0 0 1 .69-.318l2.976 1.26a.5.5 0 0 1 .318.69l-4.618 1.956a.5.5 0 0 1-.557-.103zm11.292-.004a.5.5 0 0 1 .103-.557l-1.956-4.618a.5.5 0 0 1-.69-.318l-2.976 1.26a.5.5 0 0 1-.318.69l4.618 1.956a.5.5 0 0 1 .557-.103z"/></svg>
                    <h1 class="font-orbitron text-4xl font-bold mb-8">Cognitive Engine</h1>
                </div>
                 <div class="w-full max-w-2xl">
                    <div id="main-input-area" class="relative">
                        <textarea id="main-prompt-input" rows="1" class="w-full glass p-4 pr-24 rounded-full text-base focus:ring-2 focus:ring-[var(--accent-color)] focus:outline-none transition-shadow" placeholder="What do you want to analyze?"></textarea>
                        <button id="main-voice-btn" class="absolute right-12 top-1/2 -translate-y-1/2 p-2 text-gray-400 hover:text-white transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                        </button>
                        <button id="main-send-btn" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-gray-400 hover:text-white transition-colors">
                             <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <div id="mode-selector" class="flex items-center justify-center gap-4 mt-6">
                        <button id="analyst-mode-btn" class="glass text-sm px-4 py-2 rounded-full hover:bg-white/10 transition-colors flex items-center gap-2 border border-cyan-500/50 text-cyan-300">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Analyst Mode
                        </button>
                        <button id="companion-mode-btn" class="glass text-sm px-4 py-2 rounded-full hover:bg-white/10 transition-colors flex items-center gap-2 border border-green-500/50 text-green-300">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                            Companion Mode
                        </button>
                    </div>
                </div>
            </div>

            <div id="chat-view" class="hidden flex-1 flex flex-col overflow-hidden p-6">
                <div id="chat-history-container" class="flex-1 overflow-y-auto pr-4 space-y-6">
                    </div>
                <div class="mt-6">
                    <div class="relative">
                        <button id="file-upload-btn" class="absolute left-3 top-1/2 -translate-y-1/2 p-2 text-gray-400 hover:text-white transition-colors">
                           <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                        </button>
                        <input type="file" id="file-input" class="hidden"/>
                        <textarea id="chat-prompt-input" rows="1" class="w-full glass p-4 pl-12 pr-24 rounded-full text-base focus:ring-2 focus:ring-[var(--accent-color)] focus:outline-none transition-shadow" placeholder="Continue the analysis..."></textarea>
                        <button id="voice-btn" class="absolute right-12 top-1/2 -translate-y-1/2 p-2 text-gray-400 hover:text-white transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                        </button>
                        <button id="chat-send-btn" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-gray-400 hover:text-white transition-colors">
                             <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- API Configuration ---
        // FIX 1: The vLLM server's OpenAI-compatible endpoint is at /v1/chat/completions
        const VLLM_API_URL = 'https://e4c4e1ba68e1.ngrok-free.app/v1/chat/completions';
        const MODEL_NAME = 'Malkani6/Limbus_V1'; // Assuming this is the model served
        const API_KEY = "not-needed-for-vllm"; // vLLM doesn't check the key

        // --- Element Variables ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleMobile = document.getElementById('sidebar-toggle-mobile');
        // FIX 2: Get the new desktop toggle button
        const sidebarToggleDesktop = document.getElementById('sidebar-toggle-desktop'); 
        const profileBtn = document.getElementById('profile-btn');
        const profileMenu = document.getElementById('profile-menu');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistoryList = document.getElementById('chat-history-list');
        const initialView = document.getElementById('initial-view');
        const chatView = document.getElementById('chat-view');
        const mainPromptInput = document.getElementById('main-prompt-input');
        const mainVoiceBtn = document.getElementById('main-voice-btn');
        const mainSendBtn = document.getElementById('main-send-btn');
        const analystModeBtn = document.getElementById('analyst-mode-btn');
        const companionModeBtn = document.getElementById('companion-mode-btn');
        const modeSelector = document.getElementById('mode-selector');
        const chatHistoryContainer = document.getElementById('chat-history-container');
        const fileUploadBtn = document.getElementById('file-upload-btn');
        const fileInput = document.getElementById('file-input');
        const chatPromptInput = document.getElementById('chat-prompt-input');
        const voiceBtn = document.getElementById('voice-btn');
        const chatSendBtn = document.getElementById('chat-send-btn');

        let currentMode = 'analyst';
        let isRecording = false;
        let recognition;
        let chatHistory = []; // Stores the message history for context

        // --- Mock Data (Placeholder) ---
        const mockHistory = [
            "Analysis of Cognitive Biases",
            "Body Language in Negotiations",
            "Therapeutic Dialogue Practice",
            "Deconstructing Power Dynamics",
            "Exploring Attachment Theory"
        ];

        // --- Loading Animation ---
        const loadingMessages = ["Calibrating for cognitive biases...", "Analyzing non-verbal cues...", "Ready."];
        let msgIndex = 0;
        const loadingInterval = setInterval(() => {
            if (msgIndex < loadingMessages.length) {
                loadingText.style.opacity = 0;
                setTimeout(() => {
                    loadingText.textContent = loadingMessages[msgIndex];
                    loadingText.style.opacity = 1;
                    msgIndex++;
                }, 500);
            } else {
                clearInterval(loadingInterval);
                setTimeout(() => {
                    loadingOverlay.style.opacity = 0;
                    setTimeout(() => loadingOverlay.style.display = 'none', 500);
                }, 1000);
            }
        }, 2500);
        
        // --- UI Initialization ---
        function populateHistory() {
            chatHistoryList.innerHTML = '';
            mockHistory.forEach(title => {
                const li = document.createElement('li');
                li.className = "p-3 rounded-lg cursor-pointer hover:bg-white/5 transition-colors flex items-center";
                li.innerHTML = `<svg class="w-5 h-5 mr-3 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg><span class="chat-title text-sm truncate">${title}</span>`;
                li.addEventListener('click', () => {
                    alert(`Loading chat: "${title}" (This is placeholder functionality).`);
                    // For demo purposes, we'll start a new chat in that mode
                    currentMode = title.includes("Analysis") ? 'analyst' : 'companion';
                    startChat();
                });
                chatHistoryList.appendChild(li);
            });
        }
        populateHistory();
        
        // --- Sidebar Logic ---
        sidebarToggleMobile.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
        
        // FIX 2: Add click listener for the new desktop toggle button
        if (sidebarToggleDesktop) {
            sidebarToggleDesktop.addEventListener('click', () => {
                sidebar.classList.toggle('pinned');
            });
        }
        
        if (window.innerWidth >= 768) { // Only collapse on desktop
           sidebar.classList.add('collapsed');
        }

        // --- Profile Menu ---
        profileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            profileMenu.classList.toggle('hidden');
        });
        document.addEventListener('click', (e) => {
            if (!profileBtn.contains(e.target) && !profileMenu.contains(e.target)) {
                profileMenu.classList.add('hidden');
            }
        });

        // --- Mode Selection & Chat Start ---
        function startChat(prompt = "") {
            initialView.classList.add('hidden');
            chatView.classList.remove('hidden');
            chatView.classList.add('flex');
            
            // Only add initial message if chat is new
            if (chatHistoryContainer.innerHTML === '') {
                 const systemPrompt = currentMode === 'analyst' 
                    ? "You are an expert psychological analyst. You deconstruct human behavior, identify cognitive biases, and explore underlying motivations with professional, insightful, and objective language." 
                    : "You are an empathetic companion. Your goal is to listen, validate feelings, and provide a safe, non-judgmental space. You are not a doctor, but a supportive friend. (Disclaimer: I am an AI, not a substitute for professional help.)";
                
                chatHistory = [{ role: 'system', content: systemPrompt }];

                 const initialMessage = currentMode === 'analyst' 
                    ? "Analyst Mode activated. I am ready to deconstruct the complexities of human behavior. What situation shall we analyze?" 
                    : "Companion Mode activated. I'm here to listen in a safe, non-judgmental space. What's on your mind? (Disclaimer: I am an AI, not a substitute for professional help.)";
                appendMessage(initialMessage, 'ai'); // This will also add to chatHistory
            }
            if (prompt) {
                chatPromptInput.value = prompt;
                sendMessage(chatPromptInput);
            }
        }

        analystModeBtn.addEventListener('click', () => { currentMode = 'analyst'; startChat(mainPromptInput.value); });
        companionModeBtn.addEventListener('click', () => { currentMode = 'companion'; startChat(mainPromptInput.value); });
        mainSendBtn.addEventListener('click', () => startChat(mainPromptInput.value));
        mainPromptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); startChat(mainPromptInput.value); }
        });
        newChatBtn.addEventListener('click', () => {
            if(confirm("Start a new chat? The current conversation will be saved to your history.")){
                initialView.classList.remove('hidden');
                chatView.classList.add('hidden');
                chatView.classList.remove('flex');
                chatHistoryContainer.innerHTML = '';
                mainPromptInput.value = '';
                chatHistory = []; // <-- Clear the history array
            }
        });

        // --- In-Chat Functionality ---
        chatSendBtn.addEventListener('click', () => sendMessage(chatPromptInput));
        chatPromptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(chatPromptInput); }
        });
        fileUploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if(e.target.files.length > 0) {
                alert(`File selected: ${e.target.files[0].name}. (File upload functionality is a placeholder).`);
            }
        });
        
        async function sendMessage(inputElement) {
            const messageText = inputElement.value.trim();
            if (!messageText) return;

            appendMessage(messageText, 'user');
            inputElement.value = '';
            inputElement.style.height = 'auto'; // Reset height
            
            appendTypingIndicator();

            try {
                const response = await fetch(VLLM_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`,
                        
                        // --- THIS IS THE FIX ---
                        // This header tells ngrok to skip its "browser warning" page,
                        // which was intercepting the request and causing the CORS error.
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        messages: chatHistory, // Send the entire history
                        temperature: 0.7,
                        max_tokens: 1024
                    })
                });

                if (!response.ok) {
                    // Improved error handling to show more details from the API
                    let errorText = response.statusText;
                    try {
                        // Try to parse the error message from vLLM
                        const errData = await response.json();
                        errorText += ` - ${errData.detail || JSON.stringify(errData)}`;
                    } catch (e) {
                        // Response was not JSON (e.g., a 502 Bad Gateway)
                    }
                    throw new Error(`API error: ${errorText}`);
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                removeTypingIndicator();
                appendMessage(aiResponse, 'ai');

            } catch (error) {
                console.error("Error sending message:", error);
                removeTypingIndicator();
                // This will now show the more detailed error message
                appendMessage(`**Error:** Unable to connect to the model. \n*(${error.message})*`, 'ai');
            }
        }

        function appendMessage(text, sender) {
            const messageEl = document.createElement('div');
            // Add to chat history array *before* rendering
            if (sender !== 'system') { // Don't add system prompts to visual chat
                chatHistory.push({ role: sender === 'user' ? 'user' : 'assistant', content: text });
            }

            if(sender === 'user'){
                messageEl.className = 'flex justify-end';
                messageEl.innerHTML = `<div class="glass p-3 rounded-lg max-w-xl bg-cyan-500/10 border-cyan-500/20"><p class="text-white">${text.replace(/\n/g, '<br>')}</p></div>`;
            } else {
                const accentClass = currentMode === 'analyst' ? 'text-cyan-400' : 'text-green-400';
                messageEl.className = 'flex items-start gap-3';
                messageEl.innerHTML = `<div class="flex-shrink-0 w-8 h-8 rounded-full bg-black/30 flex items-center justify-center"><svg class="w-5 h-5 ${accentClass}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14.082 2.182a.5.5 0 0 1 .103.557L12.23 8.35a.5.5 0 0 1-.69.318L8.35 6.696a.5.5 0 0 1 .318-.69l4.618-1.956a.5.5 0 0 1 .557.103zM6.696 8.35 8.652 3.732a.5.5 0 0 1 .69-.318l1.956 4.618a.5.5 0 0 1-.103.557L8.35 10.77a.5.5 0 0 1-.69-.318L6.696 8.35zm.004 11.292a.5.5 0 0 1-.103-.557l1.956-4.618a.5.5 0 0 1 .69-.318l2.976 1.26a.5.5 0 0 1 .318.69l-4.618 1.956a.5.5 0 0 1-.557-.103zm11.292-.004a.5.5 0 0 1 .103-.557l-1.956-4.618a.5.5 0 0 1-.69-.318l-2.976 1.26a.5.5 0 0 1-.318.69l4.618 1.956a.5.5 0 0 1 .557-.103z"/></svg></div><div classs="glass p-3 rounded-lg max-w-xl"><p class="text-gray-300">${text.replace(/\n/g, '<br>')}</p></div>`;
            }
            chatHistoryContainer.appendChild(messageEl);
            chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
        }

        function appendTypingIndicator() {
            const messageEl = document.createElement('div');
            messageEl.id = 'typing-indicator';
            const accentClass = currentMode === 'analyst' ? 'text-cyan-400' : 'text-green-400';
            messageEl.className = 'flex items-start gap-3';
            messageEl.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-black/30 flex items-center justify-center">
                    <svg class="w-5 h-5 ${accentClass}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14.082 2.182a.5.5 0 0 1 .103.557L12.23 8.35a.5.5 0 0 1-.69.318L8.35 6.696a.5.5 0 0 1 .318-.69l4.618-1.956a.5.5 0 0 1 .557.103zM6.696 8.35 8.652 3.732a.5.5 0 0 1 .69-.318l1.956 4.618a.5.5 0 0 1-.103.557L8.35 10.77a.5.5 0 0 1-.69-.318L6.696 8.35zm.004 11.292a.5.5 0 0 1-.103-.557l1.956-4.618a.5.5 0 0 1 .69-.318l2.976 1.26a.5.5 0 0 1 .318.69l-4.618 1.956a.5.5 0 0 1-.557-.103zm11.292-.004a.5.5 0 0 1 .103-.557l-1.956-4.618a.5.5 0 0 1-.69-.318l-2.976 1.26a.5.5 0 0 1-.318.69l4.618 1.956a.5.5 0 0 1 .557-.103z"/></svg>
                </div>
                <div class="glass p-3 rounded-lg max-w-xl">
                    <div class="flex space-x-1 items-center h-5">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>`;
            chatHistoryContainer.appendChild(messageEl);
            chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // --- Voice Transcription Logic ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            let final_transcript = '';

            recognition.onstart = () => {
                isRecording = true;
                voiceBtn.classList.add('recording', 'text-[var(--accent-color)]');
                mainVoiceBtn.classList.add('recording', 'text-[var(--accent-color)]');
            };

            recognition.onend = () => {
                isRecording = false;
                voiceBtn.classList.remove('recording', 'text-[var(--accent-color)]');
                mainVoiceBtn.classList.remove('recording', 'text-[var(--accent-color)]');
            };
            
            recognition.onresult = (event) => {
                let interim_transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        final_transcript += event.results[i][0].transcript;
                    } else {
                        interim_transcript += event.results[i][0].transcript;
                    }
                }
                const targetInput = document.body.contains(mainPromptInput) && !initialView.classList.contains('hidden') ? mainPromptInput : chatPromptInput;
                targetInput.value = final_transcript + interim_transcript;
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isRecording = false;
                voiceBtn.classList.remove('recording', 'text-[var(--accent-color)]');
                 mainVoiceBtn.classList.remove('recording', 'text-[var(--accent-color)]');
            };
            
            const toggleRecording = () => {
                if (isRecording) {
                    recognition.stop();
                } else {
                    final_transcript = '';
                    recognition.start();
                }
            };
            
            voiceBtn.addEventListener('click', toggleRecording);
            mainVoiceBtn.addEventListener('click', toggleRecording);

        } else {
            const voiceButtons = [voiceBtn, mainVoiceBtn];
            voiceButtons.forEach(btn => {
                btn.disabled = true;
                btn.title = "Voice recognition not supported in your browser.";
            });
        }
        
        // Auto-resize text areas
        [mainPromptInput, chatPromptInput].forEach(input => {
            input.addEventListener('input', () => {
                input.style.height = 'auto';
                input.style.height = `${input.scrollHeight}px`;
            });
        });
    });
    </script>
</body>
</html>
